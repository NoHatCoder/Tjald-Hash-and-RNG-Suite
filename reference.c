#include <stdint.h>

uint8_t tjaldr_seed[704]={
	0x32,0x43,0xF6,0xA8,0x88,0x5A,0x30,0x8D,0x31,0x31,0x98,0xA2,0xE0,0x37,0x07,0x34,
	0x4A,0x40,0x93,0x82,0x22,0x99,0xF3,0x1D,0x00,0x82,0xEF,0xA9,0x8E,0xC4,0xE6,0xC8,
	0x94,0x52,0x82,0x1E,0x63,0x8D,0x01,0x37,0x7B,0xE5,0x46,0x6C,0xF3,0x4E,0x90,0xC6,
	0xCC,0x0A,0xC2,0x9B,0x7C,0x97,0xC5,0x0D,0xD3,0xF8,0x4D,0x5B,0x5B,0x54,0x70,0x91,
	0x79,0x21,0x6D,0x5D,0x98,0x97,0x9F,0xB1,0xBD,0x13,0x10,0xBA,0x69,0x8D,0xFB,0x5A,
	0xC2,0xFF,0xD7,0x2D,0xBD,0x01,0xAD,0xFB,0x7B,0x8E,0x1A,0xFE,0xD6,0xA2,0x67,0xE9,
	0x6B,0xA7,0xC9,0x04,0x5F,0x12,0xC7,0xF9,0x92,0x4A,0x19,0x94,0x7B,0x39,0x16,0xCF,
	0x70,0x80,0x1F,0x2E,0x28,0x58,0xEF,0xC1,0x66,0x36,0x92,0x0D,0x87,0x15,0x74,0xE6,
	0x9A,0x45,0x8F,0xEA,0x3F,0x49,0x33,0xD7,0xE0,0xD9,0x57,0x48,0xF7,0x28,0xEB,0x65,
	0x87,0x18,0xBC,0xD5,0x88,0x21,0x54,0xAE,0xE7,0xB5,0x4A,0x41,0xDC,0x25,0xA5,0x9B,
	0x59,0xC3,0x0D,0x53,0x92,0xAF,0x26,0x01,0x3C,0x5D,0x1B,0x02,0x32,0x86,0x08,0x5F,
	0x0C,0xA4,0x17,0x91,0x8B,0x8D,0xB3,0x8E,0xF8,0xE7,0x9D,0xCB,0x06,0x03,0xA1,0x80,
	0xE6,0xC9,0xE0,0xE8,0xBB,0x01,0xE8,0xA3,0xED,0x71,0x57,0x7C,0x1B,0xD3,0x14,0xB2,
	0x77,0x8A,0xF2,0xFD,0xA5,0x56,0x05,0xC6,0x0E,0x65,0x52,0x5F,0x3A,0xA5,0x5A,0xB9,
	0x45,0x74,0x89,0x86,0x26,0x3E,0x81,0x44,0x05,0x5C,0xA3,0x96,0xA2,0xAA,0xB1,0x0B,
	0x6B,0x4C,0xC5,0xC3,0x41,0x14,0x1E,0x8C,0xEA,0x15,0x48,0x6A,0xF7,0xC7,0x2E,0x99,
	0x3B,0x3E,0xE1,0x41,0x16,0x36,0xFB,0xC2,0xA2,0xBA,0x9C,0x55,0xD7,0x41,0x83,0x1F,
	0x6C,0xE5,0xC3,0xE1,0x69,0xB8,0x79,0x31,0xEA,0xFD,0x6B,0xA3,0x36,0xC2,0x4C,0xF5,
	0xC7,0xA3,0x25,0x38,0x12,0x89,0x58,0x67,0x73,0xB8,0xF4,0x89,0x86,0xB4,0xBB,0x9A,
	0xFC,0x4B,0xFE,0x81,0xB6,0x62,0x82,0x19,0x36,0x1D,0x80,0x9C,0xCF,0xB2,0x1A,0x99,
	0x14,0x87,0xCA,0xC6,0x05,0xDE,0xC8,0x03,0x2E,0xF8,0x45,0xD5,0xDE,0x98,0x57,0x5B,
	0x1D,0xC2,0x62,0x30,0x2E,0xB6,0x51,0xB8,0x82,0x38,0x93,0xE8,0x1D,0x39,0x6A,0xCC,
	0x50,0xF6,0xD6,0xFF,0x38,0x3F,0x44,0x23,0x92,0xE0,0xB4,0x48,0x2A,0x48,0x42,0x00,
	0x46,0x9C,0x8F,0x04,0xA9,0xE1,0xF9,0xB5,0xE2,0x1C,0x66,0x84,0x2F,0x6E,0x96,0xC9,
	0xA6,0x70,0xC9,0xC6,0x1A,0xBD,0x38,0x8F,0x06,0xA5,0x1A,0x0D,0x2D,0x85,0x42,0xF6,
	0x89,0x60,0xFA,0x72,0x8A,0xB5,0x13,0x3A,0x36,0xEE,0xF0,0xB6,0xC1,0x37,0xA3,0xBE,
	0x4B,0xA3,0xBF,0x05,0x07,0xEF,0xB2,0xA9,0x8A,0x1F,0x16,0x51,0xD3,0x9A,0xF0,0x17,
	0x66,0x6C,0xA5,0x93,0xE8,0x24,0x30,0xE8,0x88,0xCE,0xE8,0x61,0x94,0x56,0xF9,0xFB,
	0x47,0xD8,0x4A,0x5C,0x33,0xB8,0xB5,0xEB,0xEE,0x06,0xF7,0x5D,0x88,0x5C,0x12,0x07,
	0x34,0x01,0xA4,0x49,0xF5,0x6C,0x16,0xAA,0x64,0xED,0x3A,0xA6,0x23,0x63,0xF7,0x70,
	0x61,0xBF,0xED,0xF7,0x24,0x29,0xB0,0x23,0xD3,0x7D,0x0D,0x72,0x4D,0x00,0xA1,0x24,
	0x8D,0xB0,0xFE,0xAD,0x34,0x9F,0x1C,0x09,0xB0,0x75,0x37,0x2C,0x98,0x09,0x91,0xB7,
	0xB2,0x5D,0x47,0x9D,0x8F,0x6E,0x8D,0xEF,0x7E,0x3F,0xE5,0x01,0xAB,0x67,0x94,0xC3,
	0xB9,0x76,0xCE,0x0B,0xD0,0x4C,0x00,0x6B,0xAC,0x1A,0x94,0xFB,0x64,0x09,0xF6,0x0C,
	0x45,0xE5,0xC9,0xEC,0x21,0x96,0xA2,0x46,0x36,0x8F,0xB6,0xFA,0xF3,0xE6,0xC5,0x3B,
	0x51,0x33,0x9B,0x2E,0xB3,0xB5,0x2E,0xC6,0xF6,0xDF,0xC5,0x11,0xF9,0xB3,0x09,0x52,
	0xCC,0xC8,0x14,0x54,0x4A,0xF5,0xEB,0xD0,0x9B,0xEE,0x3D,0x00,0x4D,0xE3,0x34,0xAF,
	0xD6,0x60,0xF2,0x80,0x71,0x92,0xE4,0xBB,0x3C,0x0C,0xBA,0x85,0x74,0x5C,0x87,0x40,
	0xFD,0x20,0xB5,0xF3,0x9B,0x9D,0x3F,0xBD,0xB5,0x57,0x9C,0x0B,0xD1,0xA6,0x03,0x20,
	0xAD,0x6A,0x10,0x0C,0x64,0x02,0xC7,0x27,0x96,0x79,0xF2,0x5F,0xEF,0xB1,0xFA,0x3C,
	0xC8,0xEA,0x5E,0x9F,0x8D,0xB3,0x22,0x2F,0x83,0xC7,0x51,0x6D,0xFF,0xD6,0x16,0xB1,
	0x52,0xF5,0x01,0xEC,0x8A,0xD0,0x55,0x2A,0xB3,0x23,0xDB,0x5F,0xAF,0xD2,0x38,0x76,
	0x05,0x33,0x17,0xB4,0x83,0xE0,0x0D,0xF8,0x29,0xE5,0xC5,0x7B,0xBC,0xA6,0xF8,0xCA,
	0x01,0xA8,0x75,0x62,0xED,0xF1,0x76,0x9D,0xBD,0x54,0x2A,0x8F,0x62,0x87,0xEF,0xFC
};

uint8_t tjaldr_sbox[256]={
	0x63,0x7c,0x77,0x7b,0xf2,0x6b,0x6f,0xc5,0x30,0x01,0x67,0x2b,0xfe,0xd7,0xab,0x76,
	0xca,0x82,0xc9,0x7d,0xfa,0x59,0x47,0xf0,0xad,0xd4,0xa2,0xaf,0x9c,0xa4,0x72,0xc0,
	0xb7,0xfd,0x93,0x26,0x36,0x3f,0xf7,0xcc,0x34,0xa5,0xe5,0xf1,0x71,0xd8,0x31,0x15,
	0x04,0xc7,0x23,0xc3,0x18,0x96,0x05,0x9a,0x07,0x12,0x80,0xe2,0xeb,0x27,0xb2,0x75,
	0x09,0x83,0x2c,0x1a,0x1b,0x6e,0x5a,0xa0,0x52,0x3b,0xd6,0xb3,0x29,0xe3,0x2f,0x84,
	0x53,0xd1,0x00,0xed,0x20,0xfc,0xb1,0x5b,0x6a,0xcb,0xbe,0x39,0x4a,0x4c,0x58,0xcf,
	0xd0,0xef,0xaa,0xfb,0x43,0x4d,0x33,0x85,0x45,0xf9,0x02,0x7f,0x50,0x3c,0x9f,0xa8,
	0x51,0xa3,0x40,0x8f,0x92,0x9d,0x38,0xf5,0xbc,0xb6,0xda,0x21,0x10,0xff,0xf3,0xd2,
	0xcd,0x0c,0x13,0xec,0x5f,0x97,0x44,0x17,0xc4,0xa7,0x7e,0x3d,0x64,0x5d,0x19,0x73,
	0x60,0x81,0x4f,0xdc,0x22,0x2a,0x90,0x88,0x46,0xee,0xb8,0x14,0xde,0x5e,0x0b,0xdb,
	0xe0,0x32,0x3a,0x0a,0x49,0x06,0x24,0x5c,0xc2,0xd3,0xac,0x62,0x91,0x95,0xe4,0x79,
	0xe7,0xc8,0x37,0x6d,0x8d,0xd5,0x4e,0xa9,0x6c,0x56,0xf4,0xea,0x65,0x7a,0xae,0x08,
	0xba,0x78,0x25,0x2e,0x1c,0xa6,0xb4,0xc6,0xe8,0xdd,0x74,0x1f,0x4b,0xbd,0x8b,0x8a,
	0x70,0x3e,0xb5,0x66,0x48,0x03,0xf6,0x0e,0x61,0x35,0x57,0xb9,0x86,0xc1,0x1d,0x9e,
	0xe1,0xf8,0x98,0x11,0x69,0xd9,0x8e,0x94,0x9b,0x1e,0x87,0xe9,0xce,0x55,0x28,0xdf,
	0x8c,0xa1,0x89,0x0d,0xbf,0xe6,0x42,0x68,0x41,0x99,0x2d,0x0f,0xb0,0x54,0xbb,0x16
};

void tjaldr_xor(uint8_t* dst,const uint8_t* op0,const uint8_t* op1){
	uint32_t a;
	for(a=0;a<16;a++){
		dst[a]=op0[a]^op1[a];
	}
}

void tjaldr_and(uint8_t* dst,const uint8_t* op0,const uint8_t* op1){
	uint32_t a;
	for(a=0;a<16;a++){
		dst[a]=op0[a]&op1[a];
	}
}

void tjaldr_add(uint8_t* dst,const uint8_t* op0,const uint8_t* op1){
	uint32_t a;
	for(a=0;a<16;a++){
		dst[a]=op0[a]+op1[a];
	}
}

void tjaldr_sub(uint8_t* dst,const uint8_t* op0,const uint8_t* op1){
	uint32_t a;
	for(a=0;a<16;a++){
		dst[a]=op0[a]-op1[a];
	}
}

void tjaldr_set(uint8_t* dst,const uint8_t* op0){
	uint32_t a;
	for(a=0;a<16;a++){
		dst[a]=op0[a];
	}
}

void tjaldr_aes(uint8_t* dst,const uint8_t* op0){
	uint32_t a;
	uint8_t result[16];
	for(a=0;a<16;a++){
		result[a]=0;
	}
	for(a=0;a<16;a++){
		uint8_t x1=tjaldr_sbox[op0[a]];
		uint8_t x2=(x1<<1)^((x1>>7)*0x1b);
		uint8_t x3=x1^x2;
		uint32_t r_in=a&3;
		uint32_t c_in=a&12;
		uint32_t c_out=(c_in-(r_in<<2))&12;
		result[c_out+((0+r_in)&3)]^=x2;
		result[c_out+((1+r_in)&3)]^=x1;
		result[c_out+((2+r_in)&3)]^=x1;
		result[c_out+((3+r_in)&3)]^=x3;
	}
	for(a=0;a<16;a++){
		dst[a]=result[a];
	}
}

void tjaldr_kernel(uint8_t* state,const uint8_t* input0,const uint8_t* input1,uint32_t jumplength,uint32_t width){
	uint32_t a,b,c;
	uint8_t storage[16];
	for(a=0;a<width;a++){
		for(b=0;b<4;b++){
			uint8_t* v0=state+a*16+width*16*0;
			uint8_t* v1=state+a*16+width*16*1;
			uint8_t* v4=state+a*16+width*16*4;
			uint8_t* v8=state+a*16+width*16*8;
			uint8_t* v10=state+a*16+width*16*10;
			const uint8_t* i0=input0+a*16+jumplength*b;
			const uint8_t* i1=input1+a*16+jumplength*b;
			tjaldr_xor(v0,v0,i0);
			tjaldr_aes(v0,v0);
			tjaldr_xor(v0,v0,v4);
			tjaldr_xor(v4,v4,i1);
			tjaldr_aes(v4,v4);
			tjaldr_xor(v4,v4,v8);
			tjaldr_xor(v8,v8,i1);
			tjaldr_aes(v8,v8);
			tjaldr_xor(v8,v8,v1);
			tjaldr_add(v10,v10,i0);
			tjaldr_set(storage,v0);
			for(c=0;c<10;c++){
				uint8_t* vc0=state+a*16+width*16*(c+0);
				uint8_t* vc1=state+a*16+width*16*(c+1);
				tjaldr_set(vc0,vc1);
			}
			tjaldr_set(v10,storage);
		}
	}
}

void tjaldr_mix(uint8_t* state){
	uint32_t b,c;
	uint8_t storage[16];
	for(b=0;b<4;b++){
		uint8_t* v0=state+16*0;
		uint8_t* v1=state+16*1;
		uint8_t* v2=state+16*2;
		uint8_t* v4=state+16*4;
		uint8_t* v8=state+16*8;
		uint8_t* v9=state+16*9;
		uint8_t* v10=state+16*10;
		tjaldr_xor(v0,v0,v8);
		tjaldr_aes(v0,v0);
		tjaldr_xor(v0,v0,v4);
		tjaldr_xor(v4,v4,v1);
		tjaldr_aes(v4,v4);
		tjaldr_xor(v4,v4,v8);
		tjaldr_xor(v8,v8,v10);
		tjaldr_aes(v8,v8);
		tjaldr_xor(v8,v8,v2);
		tjaldr_add(v9,v9,v10);
		tjaldr_set(storage,v0);
		for(c=0;c<10;c++){
			uint8_t* vc0=state+16*(c+0);
			uint8_t* vc1=state+16*(c+1);
			tjaldr_set(vc0,vc1);
		}
		tjaldr_set(v10,storage);
	}
}

void tjaldr_2(const uint8_t key[704],const void* input,size_t input_length,uint8_t out[64]){
	const uint8_t* input8=(uint8_t*)input;
	const uint8_t* inner_key=tjaldr_seed;
	if(key!=(uint8_t*)0){
		inner_key=key;
	}
	const uint8_t* final_key;
	uint32_t final_length;
	uint8_t state[704];
	uint8_t buffer[768];
	uint32_t a;
	uint64_t b;
	if(input_length>508){
		uint64_t input_length_counter=input_length;
		for(a=0;a<704;a++){
			state[a]=inner_key[a];
		}
		while(input_length_counter>512){
			tjaldr_kernel(state,input8,input8+64,128,4);
			input8+=512;
			input_length_counter-=512;
		}
		for(a=0;a<input_length_counter;a++){
			buffer[a]=input8[a];
		}
		for(a=input_length_counter;a<512;a++){
			buffer[a]=0;
		}
		tjaldr_kernel(state,buffer,buffer+64,128,4);
		for(a=0;a<704;a++){
			buffer[a]=state[a];
		}
		for(a=704;a<764;a++){
			buffer[a]=0;
		}
		input_length|=0x80000000U;
		for(a=0;a<4;a++){
			buffer[764+a]=(input_length>>(a*8))&255;
		}
		final_length=768;
		final_key=tjaldr_seed;
	}
	else{
		final_length=((uint32_t)input_length+127+4)&0xffffff80U;
		final_key=inner_key;
		for(a=0;a<input_length;a++){
			buffer[a]=input8[a];
		}
		for(a=input_length;a<final_length-4;a++){
			buffer[a]=0;
		}
		for(a=0;a<4;a++){
			buffer[final_length-4+a]=(input_length>>(a*8))&255;
		}
	}
	for(a=0;a<176;a++){
		state[a]=final_key[a];
	}
	uint8_t* final_input=buffer;
	while(final_length>0){
		tjaldr_kernel(state,final_input,final_input+16,32,1);
		final_length-=128;
		final_input+=128;
	}
	for(a=0;a<4;a++){
		tjaldr_mix(state);
	}
	tjaldr_add(state+16*0,state+16*0,state+16*1);
	tjaldr_add(state+16*2,state+16*2,state+16*3);
	tjaldr_add(state+16*4,state+16*4,state+16*5);
	tjaldr_add(state+16*6,state+16*6,state+16*8);
	tjaldr_add(state+16*7,state+16*7,state+16*10);
	tjaldr_xor(state+16*0,state+16*0,state+16*6);
	tjaldr_xor(state+16*2,state+16*2,state+16*9);
	tjaldr_set(out+16*0,state+16*0);
	tjaldr_set(out+16*1,state+16*2);
	tjaldr_set(out+16*2,state+16*4);
	tjaldr_set(out+16*3,state+16*7);
}

void tjaldr_3_round(uint8_t* state,const uint8_t* input8,uint32_t width){
	uint32_t a;
	for(a=0;a<4;a++){
		tjaldr_kernel(state,input8+a*width*128,input8+width*16+a*width*128,width*32,width);
	}
	for(a=0;a<width;a++){
		tjaldr_add(state+width*96+a*16,state+width*96+a*16,tjaldr_seed);
	}
	for(a=0;a<2;a++){
		tjaldr_kernel(state,input8+width*16+a*width*128,input8+a*width*128,width*32,width);
	}
	for(a=0;a<width;a++){
		tjaldr_add(state+width*32+a*16,state+width*32+a*16,tjaldr_seed);
	}
	for(a=2;a<4;a++){
		tjaldr_kernel(state,input8+width*16+a*width*128,input8+a*width*128,width*32,width);
	}
	for(a=0;a<width;a++){
		tjaldr_sub(state+width*32+a*16,state+width*32+a*16,tjaldr_seed);
	}
}

void tjaldr_3(const uint8_t key[704],const void* input,size_t input_length,uint8_t out[64]){
	const uint8_t* input8=(uint8_t*)input;
	const uint8_t* inner_key=tjaldr_seed;
	if(key!=(uint8_t*)0){
		inner_key=key;
	}
	const uint8_t* final_key;
	uint32_t final_length;
	uint8_t state[704];
	uint8_t buffer[2048];
	uint32_t a;
	uint64_t b;
	if(input_length>2044){
		uint64_t input_length_counter=input_length;
		for(a=0;a<704;a++){
			state[a]=inner_key[a];
		}
		while(input_length_counter>2048){
			tjaldr_3_round(state,input8,4);
			input8+=2048;
			input_length_counter-=2048;
		}
		for(a=0;a<input_length_counter;a++){
			buffer[a]=input8[a];
		}
		for(a=input_length_counter;a<2048;a++){
			buffer[a]=0;
		}
		tjaldr_3_round(state,buffer,4);
		for(a=0;a<704;a++){
			buffer[a]=state[a];
		}
		for(a=704;a<1020;a++){
			buffer[a]=0;
		}
		input_length|=0x80000000U;
		for(a=0;a<4;a++){
			buffer[1020+a]=(input_length>>(a*8))&255;
		}
		final_length=1024;
		final_key=tjaldr_seed;
	}
	else{
		final_length=((uint32_t)input_length+511+4)&0xfffffe00U;
		final_key=inner_key;
		for(a=0;a<input_length;a++){
			buffer[a]=input8[a];
		}
		for(a=input_length;a<final_length-4;a++){
			buffer[a]=0;
		}
		for(a=0;a<4;a++){
			buffer[final_length-4+a]=(input_length>>(a*8))&255;
		}
	}
	for(a=0;a<176;a++){
		state[a]=final_key[a];
	}
	uint8_t* final_input=buffer;
	while(final_length>0){
		tjaldr_3_round(state,final_input,1);
		final_length-=512;
		final_input+=512;
	}
	for(a=0;a<6;a++){
		tjaldr_mix(state);
	}
	tjaldr_add(state+16*0,state+16*0,state+16*1);
	tjaldr_add(state+16*2,state+16*2,state+16*3);
	tjaldr_add(state+16*4,state+16*4,state+16*5);
	tjaldr_add(state+16*6,state+16*6,state+16*8);
	tjaldr_add(state+16*7,state+16*7,state+16*10);
	tjaldr_xor(state+16*0,state+16*0,state+16*6);
	tjaldr_xor(state+16*2,state+16*2,state+16*9);
	tjaldr_set(out+16*0,state+16*0);
	tjaldr_set(out+16*1,state+16*2);
	tjaldr_set(out+16*2,state+16*4);
	tjaldr_set(out+16*3,state+16*7);
}

void tjaldr_4_round(uint8_t* state,const uint8_t* input8,uint32_t width){
	uint32_t a;
	for(a=0;a<8;a++){
		tjaldr_kernel(state,input8+a*width*128,input8+width*16+a*width*128,width*32,width);
	}
	for(a=0;a<width;a++){
		tjaldr_add(state+width*96+a*16,state+width*96+a*16,tjaldr_seed);
	}
	for(a=0;a<4;a++){
		tjaldr_kernel(state,input8+a*width*256,input8+width*32+a*width*256,width*64,width);
	}
	for(a=0;a<width;a++){
		tjaldr_add(state+width*32+a*16,state+width*32+a*16,tjaldr_seed);
	}
	for(a=0;a<4;a++){
		tjaldr_kernel(state,input8+width*16+a*width*256,input8+width*48+a*width*256,width*64,width);
	}
	for(a=0;a<width;a++){
		tjaldr_sub(state+width*96+a*16,state+width*96+a*16,tjaldr_seed);
	}
	for(a=0;a<3;a++){
		tjaldr_kernel(state,input8+width*16+a*width*128,input8+a*width*128,width*32,width);
	}
	for(a=0;a<width;a++){
		tjaldr_sub(state+width*32+a*16,state+width*32+a*16,tjaldr_seed);
	}
	for(a=3;a<8;a++){
		tjaldr_kernel(state,input8+width*16+a*width*128,input8+a*width*128,width*32,width);
	}
	for(a=0;a<width;a++){
		tjaldr_sub(state+width*32+a*16,state+width*32+a*16,tjaldr_seed);
	}
}

void tjaldr_4(const void* input,size_t input_length,uint8_t out[64]){
	const uint8_t* input8=(uint8_t*)input;
	uint32_t final_length;
	uint8_t state[704];
	uint8_t state_copy[704];
	uint8_t buffer[4096];
	uint32_t a;
	uint64_t b;
	if(input_length>4092){
		uint64_t input_length_counter=input_length;
		for(a=0;a<704;a++){
			state[a]=tjaldr_seed[a];
		}
		while(input_length_counter>4096){
			for(a=0;a<704;a++){
				state_copy[a]=state[a];
			}
			tjaldr_4_round(state_copy,input8,4);
			for(a=0;a<704;a++){
				state[a]^=state_copy[a];
			}
			input8+=4096;
			input_length_counter-=4096;
		}
		for(a=0;a<input_length_counter;a++){
			buffer[a]=input8[a];
		}
		for(a=input_length_counter;a<4096;a++){
			buffer[a]=0;
		}
		for(a=0;a<704;a++){
			state_copy[a]=state[a];
		}
		tjaldr_4_round(state_copy,buffer,4);
		for(a=0;a<704;a++){
			state[a]^=state_copy[a];
		}
		for(a=0;a<704;a++){
			buffer[a]=state[a];
		}
		for(a=704;a<1020;a++){
			buffer[a]=0;
		}
		input_length|=0x80000000U;
		for(a=0;a<4;a++){
			buffer[1020+a]=(input_length>>(a*8))&255;
		}
		final_length=1024;
	}
	else{
		final_length=((uint32_t)input_length+1023+4)&0xfffffc00U;
		for(a=0;a<input_length;a++){
			buffer[a]=input8[a];
		}
		for(a=input_length;a<final_length-4;a++){
			buffer[a]=0;
		}
		for(a=0;a<4;a++){
			buffer[final_length-4+a]=(input_length>>(a*8))&255;
		}
	}
	for(a=0;a<176;a++){
		state[a]=tjaldr_seed[a];
	}
	uint8_t* final_input=buffer;
	while(final_length>0){
		for(a=0;a<176;a++){
			state_copy[a]=state[a];
		}
		tjaldr_4_round(state_copy,final_input,1);
		for(a=0;a<176;a++){
			state[a]^=state_copy[a];
		}
		final_length-=1024;
		final_input+=1024;
	}
	for(a=0;a<8;a++){
		tjaldr_mix(state);
	}
	tjaldr_add(state+16*0,state+16*0,state+16*1);
	tjaldr_add(state+16*2,state+16*2,state+16*3);
	tjaldr_add(state+16*4,state+16*4,state+16*5);
	tjaldr_add(state+16*6,state+16*6,state+16*8);
	tjaldr_add(state+16*7,state+16*7,state+16*10);
	tjaldr_xor(state+16*0,state+16*0,state+16*6);
	tjaldr_xor(state+16*2,state+16*2,state+16*9);
	tjaldr_set(out+16*0,state+16*0);
	tjaldr_set(out+16*1,state+16*2);
	tjaldr_set(out+16*2,state+16*4);
	tjaldr_set(out+16*3,state+16*7);
}

#ifndef TJALD_HEADER_INCLUDED

typedef struct gesus_128_state{
	uint8_t output[1024];
	uint8_t secret[1024];
	uint8_t state[176]; 
	uint64_t spent;
} gesus_128_state;

typedef struct gesus_512_state{
	uint8_t output[4096];
	uint8_t secret[4096];
	uint8_t state[704]; 
	uint64_t spent;
} gesus_512_state;

#endif

void gesusr_128_advance(gesus_128_state* state){
	uint32_t a,b;
	uint8_t secret0[16];
	uint8_t temp[16];
	uint8_t* secret_ptr=state->secret;
	uint8_t* out_ptr=state->output;
	for(a=0;a<64;a++){
		uint8_t* v0=state->state+16*0;
		uint8_t* v1=state->state+16*1;
		uint8_t* v4=state->state+16*4;
		uint8_t* v5=state->state+16*5;
		uint8_t* v8=state->state+16*8;
		uint8_t* v9=state->state+16*9;
		uint8_t* v10=state->state+16*10;
		tjaldr_set(secret0,secret_ptr);
		tjaldr_set(secret_ptr,v8);

		tjaldr_xor(v0,v0,secret0);
		tjaldr_aes(v0,v0);
		tjaldr_xor(v0,v0,v4);
		tjaldr_xor(v4,v4,secret0);
		tjaldr_aes(v4,v4);
		tjaldr_xor(v4,v4,v8);
		tjaldr_xor(v8,v8,secret0);
		tjaldr_aes(v8,v8);
		tjaldr_xor(v8,v8,v1);
		tjaldr_add(v10,v10,secret0);
		tjaldr_and(secret0,secret0,v1);
		tjaldr_xor(secret0,secret0,v5);
		tjaldr_aes(secret0,secret0);
		tjaldr_xor(secret0,secret0,v9);
		tjaldr_set(out_ptr,secret0);
		secret_ptr+=16;
		out_ptr+=16;
		tjaldr_set(temp,v0);
		for(b=0;b<10;b++){
			tjaldr_set(state->state+16*b,state->state+16*(b+1));
		}
		tjaldr_set(v10,temp);
	}
}

void gesusr_128_seed(gesus_128_state* state,const void* seed,size_t seed_length){
	uint32_t a;
	const uint8_t* seed8=(uint8_t*)seed;
	for(a=0;a<1024;a++){
		state->secret[a]=0;
	}
	for(a=0;a<176;a++){
		state->state[a]=tjaldr_seed[a];
	}
	for(a=0;a<8;a++){
		state->state[a]^=(((uint64_t)seed_length)>>(a*8))&255;
	}
	state->spent=0;
	while(seed_length>256){
		for(a=0;a<256;a++){
			state->secret[a]^=seed8[a];
			state->secret[a+272]^=seed8[a];
			state->secret[a+736]^=seed8[a];
		}
		gesusr_128_advance(state);
		seed_length-=256;
		seed8+=256;
	}
	for(a=0;a<seed_length;a++){
		state->secret[a]^=seed8[a];
		state->secret[a+272]^=seed8[a];
		state->secret[a+736]^=seed8[a];
	}
	gesusr_128_advance(state);
}

void gesusr_128_rand(gesus_128_state* state,void* output,size_t output_length){
	uint8_t* out8=(uint8_t*)output;
	uint32_t buffer_offset=state->spent&1023;
	uint32_t left=1024-buffer_offset;
	uint32_t a;
	if(left==1024){
		left=0;
	}
	if(left>0){
		uint32_t copylength=left;
		if(output_length<=left){
			copylength=output_length;
		}
		for(a=0;a<copylength;a++){
			*out8=state->output[buffer_offset+a];
			out8++;
		}
		state->spent+=copylength;
		output_length-=copylength;
	}
	while(output_length>0){
		for(a=0;a<8;a++){
			state->secret[a]^=((state->spent)>>(a*8))&255;
		}
		uint32_t copylength=1024;
		if(output_length<copylength){
			copylength=output_length;
		}
		gesusr_128_advance(state);
		for(a=0;a<copylength;a++){
			*out8=state->output[a];
			out8++;
		}
		output_length-=copylength;
		state->spent+=copylength;
	}
}

void gesusr_512_advance(gesus_512_state* state){
	uint32_t a,b,c;
	uint8_t secret0[16];
	uint8_t temp[16];
	for(c=0;c<4;c++){
		uint8_t* secret_ptr=state->secret+c*16;
		uint8_t* out_ptr=state->output+c*16;
		for(a=0;a<64;a++){
			uint8_t* v0=state->state+16*4*0+c*16;
			uint8_t* v1=state->state+16*4*1+c*16;
			uint8_t* v4=state->state+16*4*4+c*16;
			uint8_t* v5=state->state+16*4*5+c*16;
			uint8_t* v8=state->state+16*4*8+c*16;
			uint8_t* v9=state->state+16*4*9+c*16;
			uint8_t* v10=state->state+16*4*10+c*16;
			tjaldr_set(secret0,secret_ptr);
			tjaldr_set(secret_ptr,v8);

			tjaldr_xor(v0,v0,secret0);
			tjaldr_aes(v0,v0);
			tjaldr_xor(v0,v0,v4);
			tjaldr_xor(v4,v4,secret0);
			tjaldr_aes(v4,v4);
			tjaldr_xor(v4,v4,v8);
			tjaldr_xor(v8,v8,secret0);
			tjaldr_aes(v8,v8);
			tjaldr_xor(v8,v8,v1);
			tjaldr_add(v10,v10,secret0);
			tjaldr_and(secret0,secret0,v1);
			tjaldr_xor(secret0,secret0,v5);
			tjaldr_aes(secret0,secret0);
			tjaldr_xor(secret0,secret0,v9);
			tjaldr_set(out_ptr,secret0);
			secret_ptr+=64;
			out_ptr+=64;
			tjaldr_set(temp,v0);
			for(b=0;b<10;b++){
				tjaldr_set(state->state+16*4*b+c*16,state->state+16*4*(b+1)+c*16);
			}
			tjaldr_set(v10,temp);
		}
	}
}

void gesusr_512_seed(gesus_512_state* state,const void* seed,size_t seed_length){
	gesus_128_state state128;
	gesusr_128_seed(&state128,seed,seed_length);
	gesusr_128_rand(&state128,state->secret,1616);
	size_t a;
	for(a=0;a<2480;a++){
		state->secret[a+1616]=state->secret[a];
	}
	for(a=0;a<704;a++){
		state->state[a]=state->secret[a+864];
	}
	gesusr_512_advance(state);
	state->spent=0;
}

void gesusr_512_rand(gesus_512_state* state,void* output,size_t output_length){
	uint8_t* out8=(uint8_t*)output;
	uint32_t buffer_offset=state->spent&4095;
	uint32_t left=4096-buffer_offset;
	uint32_t a,b;
	if(left==4096){
		left=0;
	}
	if(left>0){
		uint32_t copylength=left;
		if(output_length<=left){
			copylength=output_length;
		}
		for(a=0;a<copylength;a++){
			*out8=state->output[buffer_offset+a];
			out8++;
		}
		state->spent+=copylength;
		output_length-=copylength;
	}
	while(output_length>0){
		for(b=0;b<4;b++){
			for(a=0;a<8;a++){
				state->secret[a+b*16]^=((state->spent+b)>>(a*8))&255;
			}
		}
		uint32_t copylength=4096;
		if(output_length<copylength){
			copylength=output_length;
		}
		gesusr_512_advance(state);
		for(a=0;a<copylength;a++){
			*out8=state->output[a];
			out8++;
		}
		output_length-=copylength;
		state->spent+=copylength;
	}
}

void tjaldr_expand_seed(const void* seed,size_t seed_length,uint8_t expanded_key[704]){
	gesus_128_state state;
	gesusr_128_seed(&state,seed,seed_length);
	gesusr_128_rand(&state,expanded_key,704);
}